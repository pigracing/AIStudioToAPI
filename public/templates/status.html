<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Google AI Studio Proxy - Service Status</title>

    <!-- Import Vue.js and Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>

    <style>
        body {
            font-family: 'SF Mono', 'Consolas', 'Menlo', monospace;
            background-color: #f0f2f5;
            color: #333;
            padding: 2em;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 1em 2em 2em 2em;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1,
        h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5em;
        }

        pre {
            background: #2d2d2d;
            color: #f0f0f0;
            font-size: 1.1em;
            padding: 1.5em;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        #log-container {
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }

        .status-ok {
            color: #2ecc71;
            font-weight: bold;
        }

        .status-error {
            color: #e74c3c;
            font-weight: bold;
        }

        .label {
            display: inline-block;
            width: 220px;
        }

        .dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            animation: blink 1s infinite alternate;
        }

        .dot.status-running {
            background-color: #2ecc71;
        }

        .dot.status-error {
            background-color: #e74c3c;
        }

        @keyframes blink {
            from {
                opacity: 0.3;
            }

            to {
                opacity: 1;
            }
        }

        .action-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .action-group button,
        .action-group select {
            font-size: 1em;
            border: 1px solid #ccc;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            line-height: 1.5;
            min-height: 44px;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .action-group button:hover {
            opacity: 0.85;
        }

        .action-group button {
            background-color: #007bff;
            color: white;
        }

        .lang-switcher {
            position: absolute;
            top: 35px;
            right: 20px;
            background: transparent;
            border: none;
            color: #666;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lang-switcher:hover {
            color: #007bff;
            transform: scale(1.1);
        }

        .lang-switcher svg {
            display: block;
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .switch-container .switch-label {
            font-size: 1em;
            color: #333;
            min-width: 150px;
            font-weight: 500;
        }

        .switch-container .switch-status {
            font-size: 0.9em;
            color: #666;
            min-width: 60px;
        }

        #app {
            display: contents;
        }

        /* Element Plus button theme override */
        .el-button--primary {
            --el-button-bg-color: #007bff;
            --el-button-border-color: #007bff;
            --el-button-hover-bg-color: #0069d9;
            --el-button-hover-border-color: #0069d9;
            --el-button-active-bg-color: #0056b3;
            --el-button-active-border-color: #0056b3;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <button class="lang-switcher" onclick="toggleLanguage()" title="Switch Language">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m5 8 6 6"></path>
                    <path d="m4 14 6-6 2-3"></path>
                    <path d="M2 5h12"></path>
                    <path d="M7 2h1"></path>
                    <path d="m22 22-5-10-5 10"></path>
                    <path d="M14 18h6"></path>
                </svg>
            </button>
            <h1><span data-i18n="heading">Proxy Service Status</span> <span class="dot"></span></h1>
            <div id="status-section">
                <pre>
<span class="label" data-i18n="serviceStatus">Service Status</span>: <span class="status-ok" data-i18n="running">Running</span>
<span class="label" data-i18n="browserConnection">Browser Connection</span>: <span class="{{browserConnectedClass}}">{{browserConnected}}</span>
--- <span data-i18n="serviceConfig">Service Configuration</span> ---
<span class="label" data-i18n="streamingMode">Streaming Mode</span>: {{streamingMode}}
<span class="label" data-i18n="forceThinking">Force Thinking</span>: {{forceThinking}}
<span class="label" data-i18n="forceWebSearch">Force Web Search</span>: {{forceWebSearch}}
<span class="label" data-i18n="forceUrlContext">Force URL Context</span>: {{forceUrlContext}}
<span class="label" data-i18n="apiKey">API Key</span>: {{apiKeySource}}
--- <span data-i18n="accountStatus">Account Status</span> ---
<span class="label" data-i18n="currentAccount">Current Active Account</span>: #{{currentAuthIndex}} ({{currentAccountName}})
<span class="label" data-i18n="usageCount">Usage Count</span>: {{usageCount}}
<span class="label" data-i18n="consecutiveFailures">Consecutive Failures</span>: {{failureCount}}
<span class="label" data-i18n="totalScanned">Total Scanned Accounts</span>: {{totalScannedAccounts}}
{{accountDetailsHtml}}
<span class="label" data-i18n="formatErrors">Format Errors (Ignored)</span>: {{formatErrors}}
        </pre>
            </div>
            <div id="actions-section" style="margin-top: 2em;">
                <h2 data-i18n="actionsPanel">Actions Panel</h2>
                <div class="action-group">
                    <select id="account-index-select">{{accountOptionsHtml}}</select>
                    <button onclick="switchSpecificAccount()" data-i18n="btnSwitchAccount">Switch Account</button>
                </div>
                <div class="switch-container">
                    <span class="switch-label" data-i18n="streamingMode">Streaming Mode</span>
                    <el-switch v-model="streamingModeReal" :before-change="handleStreamingModeBeforeChange"
                        style="--el-switch-on-color: #007bff; --el-switch-off-color: #dcdfe6">
                    </el-switch>
                    <span class="switch-status">{{ streamingModeText }}</span>
                </div>
                <div class="switch-container">
                    <span class="switch-label" data-i18n="forceThinking">Force Thinking</span>
                    <el-switch v-model="forceThinkingEnabled" :before-change="handleForceThinkingBeforeChange"
                        style="--el-switch-on-color: #007bff; --el-switch-off-color: #dcdfe6">
                    </el-switch>
                    <span class="switch-status">{{ forceThinkingText }}</span>
                </div>
                <div class="switch-container">
                    <span class="switch-label" data-i18n="forceWebSearch">Force Web Search</span>
                    <el-switch v-model="forceWebSearchEnabled" :before-change="handleForceWebSearchBeforeChange"
                        style="--el-switch-on-color: #007bff; --el-switch-off-color: #dcdfe6">
                    </el-switch>
                    <span class="switch-status">{{ forceWebSearchText }}</span>
                </div>
                <div class="switch-container">
                    <span class="switch-label" data-i18n="forceUrlContext">Force URL Context</span>
                    <el-switch v-model="forceUrlContextEnabled" :before-change="handleForceUrlContextBeforeChange"
                        style="--el-switch-on-color: #007bff; --el-switch-off-color: #dcdfe6">
                    </el-switch>
                    <span class="switch-status">{{ forceUrlContextText }}</span>
                </div>
            </div>
            <div id="log-section" style="margin-top: 2em;">
                <h2><span data-i18n="realtimeLogs">Real-time Logs</span> (<span data-i18n="latestEntries">Latest</span>
                    {{logCount}} <span data-i18n="entries">entries</span>)</h2>
                <pre id="log-container">{{logs}}</pre>
            </div>
        </div>
    </div>
    <script>
        // ========== Internationalization Support ==========
        const translations = {
            en: {
                title: 'Google AI Studio Proxy - Service Status',
                heading: 'Proxy Service Status',
                serviceStatus: 'Service Status',
                running: 'Running',
                disconnected: 'Disconnected',
                browserConnection: 'Browser Connection',
                serviceConfig: 'Service Configuration',
                streamingMode: 'Streaming Mode',
                forceThinking: 'Force Thinking',
                forceWebSearch: 'Force Web Search',
                forceUrlContext: 'Force URL Context',
                apiKey: 'API Key',
                accountStatus: 'Account Status',
                currentAccount: 'Current Active Account',
                usageCount: 'Usage Count',
                consecutiveFailures: 'Consecutive Failures',
                totalScanned: 'Total Scanned Accounts',
                formatErrors: 'Format Errors (Ignored)',
                actionsPanel: 'Actions Panel',
                btnSwitchAccount: 'Switch Account',
                realtimeLogs: 'Real-time Logs',
                latestEntries: 'Latest',
                entries: 'entries',
                account: 'Account',
                immediateSwitchCodes: 'Immediate Switch (Codes)',
                confirmSwitch: 'Are you sure you want to switch to account',
                operationInProgress: 'Operation in progress...',
                settingFailed: 'Setting failed: ',
                alreadyCurrentAccount: 'This is already the current active account.'
            },
            zh: {
                title: 'Google AI Studio 代理 - 服务状态',
                heading: '代理服务状态',
                serviceStatus: '服务状态',
                running: '运行中',
                disconnected: '连接失败',
                browserConnection: '浏览器连接',
                serviceConfig: '服务配置',
                streamingMode: '流式模式',
                forceThinking: '强制思考',
                forceWebSearch: '强制联网',
                forceUrlContext: '强制网址上下文',
                apiKey: 'API 密钥',
                accountStatus: '账户状态',
                currentAccount: '当前活动账户',
                usageCount: '使用次数',
                consecutiveFailures: '连续失败次数',
                totalScanned: '已扫描账户总数',
                formatErrors: '格式错误（已忽略）',
                actionsPanel: '操作面板',
                btnSwitchAccount: '切换账户',
                realtimeLogs: '实时日志',
                latestEntries: '最新',
                entries: '条',
                account: '账户',
                immediateSwitchCodes: '立即切换（代码）',
                confirmSwitch: '确定要切换到账户',
                operationInProgress: '操作进行中...',
                settingFailed: '设置失败：',
                alreadyCurrentAccount: '当前已经是该账户，无需切换。'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';

        const applyLanguage = lang => {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.documentElement.lang = lang;

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Refresh content to apply translations
            updateContent();
        };

        const toggleLanguage = () => {
            const newLang = currentLang === 'en' ? 'zh' : 'en';
            applyLanguage(newLang);
        };

        const t = key => translations[currentLang][key] || key;

        // ========== Vue App ==========
        let vueApp = null;
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    streamingModeReal: false,
                    forceThinkingEnabled: false,
                    forceWebSearchEnabled: false,
                    forceUrlContextEnabled: false,
                    isUpdating: false,
                    currentAuthIndex: -1,
                }
            },
            computed: {
                streamingModeText() {
                    return this.streamingModeReal ? 'real' : 'fake';
                },
                forceThinkingText() {
                    return this.forceThinkingEnabled ? 'true' : 'false';
                },
                forceWebSearchText() {
                    return this.forceWebSearchEnabled ? 'true' : 'false';
                },
                forceUrlContextText() {
                    return this.forceUrlContextEnabled ? 'true' : 'false';
                },
            },
            methods: {
                handleStreamingModeBeforeChange() {
                    if (this.isUpdating) { return false; }

                    const newValue = !this.streamingModeReal;
                    const newMode = newValue ? 'real' : 'fake';

                    return new Promise((resolve, reject) => {
                        fetch('/api/set-mode', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ mode: newMode })
                        })
                            .then(res => res.text())
                            .then(data => {
                                ElementPlus.ElMessage.success(data);
                                updateContent();
                                resolve(true);
                            })
                            .catch(err => {
                                ElementPlus.ElMessage.error(t('settingFailed') + err);
                                reject();
                            });
                    });
                },
                handleForceThinkingBeforeChange() {
                    if (this.isUpdating) { return false; }

                    const newValue = !this.forceThinkingEnabled;

                    return new Promise((resolve, reject) => {
                        fetch('/api/toggle-force-thinking', { method: 'POST' })
                            .then(res => res.text())
                            .then(data => {
                                ElementPlus.ElMessage.success(data);
                                updateContent();
                                resolve(true);
                            })
                            .catch(err => {
                                ElementPlus.ElMessage.error(t('settingFailed') + err);
                                reject();
                            });
                    });
                },
                handleForceWebSearchBeforeChange() {
                    if (this.isUpdating) { return false; }

                    const newValue = !this.forceWebSearchEnabled;

                    return new Promise((resolve, reject) => {
                        fetch('/api/toggle-force-web-search', { method: 'POST' })
                            .then(res => res.text())
                            .then(data => {
                                ElementPlus.ElMessage.success(data);
                                updateContent();
                                resolve(true);
                            })
                            .catch(err => {
                                ElementPlus.ElMessage.error(t('settingFailed') + err);
                                reject();
                            });
                    });
                },
                handleForceUrlContextBeforeChange() {
                    if (this.isUpdating) { return false; }

                    const newValue = !this.forceUrlContextEnabled;

                    return new Promise((resolve, reject) => {
                        fetch('/api/toggle-force-url-context', { method: 'POST' })
                            .then(res => res.text())
                            .then(data => {
                                ElementPlus.ElMessage.success(data);
                                updateContent();
                                resolve(true);
                            })
                            .catch(err => {
                                ElementPlus.ElMessage.error(t('settingFailed') + err);
                                reject();
                            });
                    });
                },
                updateSwitchStates(data) {
                    this.isUpdating = true;
                    this.streamingModeReal = data.status.streamingMode.includes('real');
                    this.forceThinkingEnabled = data.status.forceThinking.includes('Enabled');
                    this.forceWebSearchEnabled = data.status.forceWebSearch.includes('Enabled');
                    this.forceUrlContextEnabled = data.status.forceUrlContext.includes('Enabled');
                    this.currentAuthIndex = data.status.currentAuthIndex;
                    this.$nextTick(() => {
                        this.isUpdating = false;
                    });
                }
            },
            mounted() {
                vueApp = this;

                const initialMode = '{{streamingMode}}';
                const initialThinking = '{{forceThinking}}';
                const initialWebSearch = '{{forceWebSearch}}';
                const initialUrlContext = '{{forceUrlContext}}';
                const initialAuthIndex = '{{currentAuthIndex}}';

                this.isUpdating = true;
                this.streamingModeReal = initialMode === 'real';
                this.forceThinkingEnabled = initialThinking === 'true' || initialThinking === true;
                this.forceWebSearchEnabled = initialWebSearch === 'true' || initialWebSearch === true;
                this.forceUrlContextEnabled = initialUrlContext === 'true' || initialUrlContext === true;
                this.currentAuthIndex = parseInt(initialAuthIndex, 10);

                this.$nextTick(() => {
                    this.isUpdating = false;
                });
            }
        }).use(ElementPlus).mount('#app');

        const updateContent = () => {
            const dot = document.querySelector('.dot');
            fetch('/api/status').then(r => r.json()).then(data => {
                // Update dot to green when connected
                dot.className = 'dot status-running';

                // Update Vue switch states
                if (vueApp && vueApp.updateSwitchStates) {
                    vueApp.updateSwitchStates(data);
                }

                const statusPre = document.querySelector('#status-section pre');
                const accountDetailsHtml = data.status.accountDetails.map(acc =>
                    '<span class="label" style="padding-left: 20px;">' + t('account') + ' ' + acc.index + '</span>: ' + acc.name
                ).join('\n');
                statusPre.innerHTML =
                    '<span class="label">' + t('serviceStatus') + '</span>: <span class="status-ok">' + t('running') + '</span>\n' +
                    '<span class="label">' + t('browserConnection') + '</span>: <span class="' + (data.status.browserConnected ? "status-ok" : "status-error") + '">' + data.status.browserConnected + '</span>\n' +
                    '--- ' + t('serviceConfig') + ' ---\n' +
                    '<span class="label">' + t('streamingMode') + '</span>: ' + data.status.streamingMode + '\n' +
                    '<span class="label">' + t('forceThinking') + '</span>: ' + data.status.forceThinking + '\n' +
                    '<span class="label">' + t('forceWebSearch') + '</span>: ' + data.status.forceWebSearch + '\n' +
                    '<span class="label">' + t('forceUrlContext') + '</span>: ' + data.status.forceUrlContext + '\n' +
                    '<span class="label">' + t('immediateSwitchCodes') + '</span>: ' + data.status.immediateSwitchStatusCodes + '\n' +
                    '<span class="label">' + t('apiKey') + '</span>: ' + data.status.apiKeySource + '\n' +
                    '--- ' + t('accountStatus') + ' ---\n' +
                    '<span class="label">' + t('currentAccount') + '</span>: #' + data.status.currentAuthIndex + ' (' + data.status.currentAccountName + ')\n' +
                    '<span class="label">' + t('usageCount') + '</span>: ' + data.status.usageCount + '\n' +
                    '<span class="label">' + t('consecutiveFailures') + '</span>: ' + data.status.failureCount + '\n' +
                    '<span class="label">' + t('totalScanned') + '</span>: ' + data.status.initialIndices + '\n' +
                    accountDetailsHtml + '\n' +
                    '<span class="label">' + t('formatErrors') + '</span>: ' + data.status.invalidIndices;

                const logContainer = document.getElementById('log-container');
                const logTitle = document.querySelector('#log-section h2');
                const isScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 1;
                logTitle.innerHTML = '<span data-i18n="realtimeLogs">' + t('realtimeLogs') + '</span> (<span data-i18n="latestEntries">' + t('latestEntries') + '</span> ' + data.logCount + ' <span data-i18n="entries">' + t('entries') + '</span>)';
                logContainer.innerText = data.logs;
                if (isScrolledToBottom) { logContainer.scrollTop = logContainer.scrollHeight; }
            }).catch(err => {
                console.error('Error:', err);
                // Update dot to red when connection fails
                dot.className = 'dot status-error';

                // Update service status to disconnected
                const statusPre = document.querySelector('#status-section pre');
                statusPre.innerHTML = '<span class="label">' + t('serviceStatus') + '</span>: <span class="status-error">' + t('disconnected') + '</span>';
            });
        }

        const switchSpecificAccount = () => {
            const targetIndex = parseInt(document.getElementById('account-index-select').value, 10);

            // Check if target account is the same as current account
            if (vueApp && vueApp.currentAuthIndex === targetIndex) {
                ElementPlus.ElMessage.warning(t('alreadyCurrentAccount'));
                return;
            }

            ElementPlus.ElMessageBox.confirm(
                t('confirmSwitch') + ' #' + targetIndex + '?',
                {
                    confirmButtonText: currentLang === 'zh' ? '确定' : 'OK',
                    cancelButtonText: currentLang === 'zh' ? '取消' : 'Cancel',
                    type: 'warning'
                }
            )
                .then(() => {
                    const loading = ElementPlus.ElLoading.service({
                        lock: true,
                        text: 'Switching account, please wait...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });

                    fetch('/api/switch-account', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ targetIndex: targetIndex })
                    })
                        .then(async res => {
                            const data = await res.text();
                            loading.close();
                            if (res.ok) {
                                ElementPlus.ElMessage.success(data);
                            } else {
                                ElementPlus.ElMessage.error(data);
                            }
                            updateContent();
                        })
                        .catch(err => {
                            loading.close();
                            ElementPlus.ElMessage.error(t('settingFailed') + (err.message || err));
                            updateContent();
                        });
                })
                .catch(() => {
                    // User cancelled
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            applyLanguage(currentLang);
            const scheduleNextUpdate = () => {
                const randomInterval = 4000 + Math.floor(Math.random() * 3000); // Random interval 4-7 seconds
                setTimeout(() => {
                    updateContent();
                    scheduleNextUpdate(); // Recursively schedule next update
                }, randomInterval);
            };
            scheduleNextUpdate(); // Start random interval refresh
        });
    </script>
</body>

</html>
